{% extends 'base.html.twig' %}

{% block title %}{{ product.name }}{% endblock %}

{% block breadcrumb %}
    {% include 'partials/_breadcrumb.html.twig' with {
        items: [
            { label: 'Home', url: path('app_home') },
            { label: product.category ? product.category.name : 'Category', url: product.category ? path('app_category_show', { slug: product.category.slug }) : null },
            { label: product.name }
        ]
    } %}
{% endblock %}

{% block body %}
    {% set imagePath = resolve_image_path(product.image) %}
    {% set stockValue = product.stock is not null ? product.stock + 0 : null %}
    {% set maxQuantity = stockValue is not null and stockValue > 0 ? stockValue : 99 %}
    {% set isOutOfStock = stockValue is not null and stockValue <= 0 %}

    <div class="container py-4 px-4 product-detail-page">
        {{ block('breadcrumb') }}

        <div class="row g-4 g-lg-5 align-items-start">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body bg-light border rounded-4 p-4 d-flex align-items-center justify-content-center">
                        {% if imagePath %}
                            <img src="{{ imagePath }}" alt="{{ product.name }}" class="img-fluid rounded-3 shadow-sm">
                        {% else %}
                            <div class="text-center text-muted w-100 py-5">
                                <span class="display-6">No image available</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <div class="d-flex flex-column gap-3">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                                <div>
                                    <h1 class="h3 mb-1">{{ product.name }}</h1>
                                    <p class="text-muted mb-0">
                                        {{ product.category ? product.category.name : 'Uncategorized' }}
                                    </p>
                                </div>
                                <div class="d-flex gap-2">
                                    {% if stockValue is not null %}
                                        <span class="badge {{ isOutOfStock ? 'bg-danger' : 'bg-primary-subtle text-primary-emphasis' }} rounded-pill">
                                            {{ isOutOfStock ? 'Stokta Yok' : 'Stok: ' ~ stockValue }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex align-items-baseline gap-3">
                                <p class="display-6 fw-semibold mb-0">{{ product.price|number_format(2, ',', '.') }} ‚Ç∫</p>
                                {% if stockValue is not null and stockValue > 0 %}
                                    <small class="text-muted">Adet fiyatƒ±</small>
                                {% endif %}
                            </div>

                            {% if product.description %}
                                <p class="text-secondary mb-0">{{ product.description|nl2br }}</p>
                            {% endif %}

                            {% set quantityInputId = 'quantity-' ~ product.id %}
                            <form action="{{ path('app_cart_add', {id: product.id}) }}" method="post" class="mt-2" id="add-to-cart-form-{{ product.id }}">
                                <div class="row g-3 align-items-end">
                                    <div class="col-sm-4">
                                        <label for="{{ quantityInputId }}" class="form-label mb-1">Quantity</label>
                                        <input
                                            type="number"
                                            name="quantity"
                                            id="{{ quantityInputId }}"
                                            value="1"
                                            min="1"
                                            max="{{ maxQuantity }}"
                                            class="form-control"
                                            {{ isOutOfStock ? 'disabled' : '' }}
                                        >
                                    </div>
                                    <div class="col-sm">
                                        <button
                                            class="btn btn-success btn-lg px-4 add-to-cart w-100"
                                            type="button"
                                            data-product-id="{{ product.id }}"
                                            data-product-name="{{ product.name|e('html_attr') }}"
                                            data-cart-url="{{ path('app_cart_add', {id: product.id}) }}"
                                            data-quantity-input="#{{ quantityInputId }}"
                                            data-fallback-form="add-to-cart-form-{{ product.id }}"
                                            {{ isOutOfStock ? 'disabled' : '' }}
                                        >
                                            üõí Sepete Ekle
                                        </button>
                                        <noscript>
                                            <button class="btn btn-success btn-lg px-4 mt-2 w-100" type="submit" {{ isOutOfStock ? 'disabled' : '' }}>
                                                üõí Sepete Ekle
                                            </button>
                                        </noscript>
                                    </div>
                                </div>
                                {% if isOutOfStock %}
                                    <p class="text-danger small mt-2 mb-0">Bu √ºr√ºn ≈üu anda stokta yok.</p>
                                {% endif %}
                            </form>

                            <div class="card bg-light border-0 mt-3">
                                <div class="card-body p-3">
                                    <h2 class="h6 text-uppercase text-muted mb-3">√úr√ºn Bilgileri</h2>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">√úr√ºn No</dt>
                                        <dd class="col-sm-7 mb-2">#{{ product.id }}</dd>

                                        <dt class="col-sm-5 text-muted">Kategori</dt>
                                        <dd class="col-sm-7 mb-2">{{ product.category ? product.category.name : 'Uncategorized' }}</dd>

                                        <dt class="col-sm-5 text-muted">Stok Durumu</dt>
                                        <dd class="col-sm-7 mb-2">
                                            {% if stockValue is null %}
                                                Bilgi yok
                                            {% elseif isOutOfStock %}
                                                Stokta Yok
                                            {% else %}
                                                {{ stockValue }} adet
                                            {% endif %}
                                        </dd>

                                        <dt class="col-sm-5 text-muted">Olu≈üturulma</dt>
                                        <dd class="col-sm-7 mb-2">{{ product.createdAt ? product.createdAt|date('d M Y H:i') : '‚Äî' }}</dd>

                                        <dt class="col-sm-5 text-muted">G√ºncellenme</dt>
                                        <dd class="col-sm-7 mb-0">{{ product.updatedAt ? product.updatedAt|date('d M Y H:i') : '‚Äî' }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <div class="d-flex flex-wrap gap-2 mt-3">
                                {% if is_granted('ROLE_ADMIN') %}
                                    <a href="{{ path('app_product_index') }}" class="btn btn-outline-secondary">
                                        ‚Üê √úr√ºn listesine d√∂n
                                    </a>
                                    <a href="{{ path('app_product_edit', {'id': product.id}) }}" class="btn btn-outline-primary">
                                        √úr√ºn√º d√ºzenle
                                    </a>
                                {% else %}
                                    <a href="{{ path('app_home') }}" class="btn btn-outline-secondary">
                                        ‚Üê Alƒ±≈üveri≈üe devam et
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if is_granted('ROLE_ADMIN') %}
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body p-4">
                    <h2 class="h6 text-uppercase text-muted mb-3">Y√∂netici ƒ∞≈ülemleri</h2>
                    {{ include('product/_delete_form.html.twig') }}
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
