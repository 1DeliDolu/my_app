<!DOCTYPE html>
<html>
  <head>
      <meta charset="UTF-8">
      <title>{% block title %}Shop{% endblock %}</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
      {{ importmap('app') }}
  </head>
  <body>
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
          <div class="container px-4">
              <a class="navbar-brand fw-bold text-warning" href="{{ path('app_home') }}">Pehli<span class="text-light">ONE</span></a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                  <ul class="navbar-nav me-auto">
                      <li class="nav-item"><a class="nav-link" href="{{ path('app_home') }}">Home</a></li>
                      {% if is_granted('ROLE_ADMIN') %}
                          <li class="nav-item"><a class="nav-link" href="{{ path('app_product_index') }}">Products</a></li>
                      {% endif %}
                  </ul>
                  <ul class="navbar-nav align-items-center gap-lg-3">
                      <li class="nav-item position-relative">
                          <a class="nav-link position-relative d-flex align-items-center" href="{{ path('app_cart_index') }}" aria-label="View cart">
                              <span class="fs-5" aria-hidden="true">ðŸ›’</span>
                              <span id="cart-count" class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill">
                                  {{ cartItemCount|default(0) }}
                              </span>
                              <span class="visually-hidden">Cart items</span>
                          </a>
                      </li>
                      {% if app.user %}
                      {% if is_granted('ROLE_ADMIN') %}
                          <li class="nav-item">
                              <a class="nav-link" href="{{ path('app_admin_users') }}">Users</a>
                          </li>
                      {% endif %}
                      <li class="nav-item">
                          <a class="nav-link" href="{{ path('app_order_index') }}">Orders</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="{{ path('app_address_index') }}">Addresses</a>
                      </li>
                      <li class="nav-item">
                          <span class="nav-link">Welcome, {{ app.user.firstName }}</span>
                          </li>
                          <li class="nav-item">
                              <a class="nav-link" href="{{ path('app_logout') }}">Logout</a>
                          </li>
                      {% else %}
                          <li class="nav-item">
                              <a class="nav-link" href="{{ path('app_login') }}">Login</a>
                          </li>
                          <li class="nav-item">
                              <a class="nav-link" href="{{ path('app_register') }}">Register</a>
                          </li>
                      {% endif %}
                  </ul>
              </div>
          </div>
      </nav>

      <main class="py-4">
          {% block body %}{% endblock %}
      </main>

      <div class="modal fade" id="addToCartModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content shadow-lg border-0">
                  <div class="modal-header bg-success text-white">
                      <h5 class="modal-title">ÃœrÃ¼n sepete eklendi</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <p class="mb-1 text-muted">Sepete eklenen Ã¼rÃ¼n:</p>
                      <p class="h5 mb-3" id="modal-product-name">â€”</p>
                      <p class="text-muted mb-0">
                          AlÄ±ÅŸveriÅŸe devam etmek ister misiniz yoksa sepetinize gitmek mi istersiniz?
                      </p>
                  </div>
                  <div class="modal-footer bg-light border-0">
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">AlÄ±ÅŸveriÅŸe Devam Et</button>
                      <a href="{{ path('app_cart_index') }}" class="btn btn-success">Sepete Git</a>
                  </div>
              </div>
          </div>
      </div>

      {% block javascripts %}
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script>
      document.addEventListener('DOMContentLoaded', function () {
          const cartCountEl = document.getElementById('cart-count');
          const modalElement = document.getElementById('addToCartModal');
          const modalProductName = document.getElementById('modal-product-name');
          const addToCartModal = modalElement && typeof bootstrap !== 'undefined'
              ? new bootstrap.Modal(modalElement)
              : null;

          const updateCartCount = (value) => {
              if (!cartCountEl) {
                  return;
              }

              const numericValue = Number.parseInt(value, 10);
              cartCountEl.textContent = Number.isFinite(numericValue) && numericValue >= 0 ? numericValue : 0;
          };

          let addToCartHandlerBound = false;

          const attachAddToCartHandlers = () => {
            if (addToCartHandlerBound) {
                return;
            }
            addToCartHandlerBound = true;

            document.addEventListener('click', async (event) => {
                const button = event.target.closest('.add-to-cart');
                if (!button) {
                    return;
                }

                event.preventDefault();

                const cartUrl = button.dataset.cartUrl;
                if (!cartUrl) {
                    return;
                }

                let quantity = button.dataset.quantity || '1';
                const quantitySelector = button.dataset.quantityInput || button.dataset.quantitySelector;
                if (quantitySelector) {
                    const scope = button.closest('form') || button.closest('.card') || document;
                    let quantityInput = scope.querySelector(quantitySelector);

                    if (!quantityInput) {
                        quantityInput = document.querySelector(quantitySelector);
                    }
                    if (quantityInput && quantityInput.value) {
                        quantity = quantityInput.value;
                    }
                }

                const payload = new URLSearchParams();
                payload.set('quantity', quantity);

                button.disabled = true;
                button.classList.add('opacity-50');

                try {
                    const response = await fetch(cartUrl, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: payload,
                    });

                    if (!response.ok) {
                        throw new Error(`Request failed with status ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        if (data.cartCount !== undefined) {
                            updateCartCount(data.cartCount);
                        }

                        if (modalProductName) {
                            modalProductName.textContent = button.dataset.productName || 'ÃœrÃ¼n';
                        }

                        if (addToCartModal) {
                            addToCartModal.show();
                        } else {
                            const goToCart = window.confirm('ÃœrÃ¼n sepete eklendi. Sepete gitmek ister misiniz?');
                            if (goToCart) {
                                window.location.href = '{{ path('app_cart_index') }}';
                            }
                        }
                    } else if (button.dataset.fallbackForm) {
                        const fallbackForm = document.getElementById(button.dataset.fallbackForm);
                        if (fallbackForm) {
                            fallbackForm.submit();
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Add to cart error:', error);
                    alert('ÃœrÃ¼n sepete eklenirken bir sorun oluÅŸtu. LÃ¼tfen tekrar deneyin.');
                } finally {
                    button.disabled = false;
                    button.classList.remove('opacity-50');
                }
            });
        };

          attachAddToCartHandlers();

          const categoryList = document.getElementById('category-list');
          const productList = document.getElementById('product-list');

          if (!categoryList || !productList) {
              return;
          }

          const categoryLinks = categoryList.querySelectorAll('.category-link');
          const allProductsLink = document.getElementById('all-products-link');
          const listItems = categoryList.querySelectorAll('.list-group-item');
          const categoryTitle = document.getElementById('category-title');
          const categoryDescription = document.getElementById('category-description');

          const setActive = (activeElement) => {
              listItems.forEach((item) => item.classList.remove('active'));
              if (activeElement) {
                  activeElement.classList.add('active');
              }
          };

          const updateCategoryDetails = (sourceElement) => {
              if (!sourceElement) {
                  return;
              }

              if (categoryTitle && sourceElement.dataset.categoryName) {
                  categoryTitle.textContent = sourceElement.dataset.categoryName;
              }

              if (categoryDescription) {
                  const description = sourceElement.dataset.categoryDescription || '';
                  categoryDescription.textContent = description;

                  if (description.trim().length === 0) {
                      categoryDescription.classList.add('d-none');
                  } else {
                      categoryDescription.classList.remove('d-none');
                  }
              }
          };

          const loadProducts = (url, activeElement) => {
              if (!url) {
                  return;
              }

              fetch(url, {
                  headers: {
                      'X-Requested-With': 'XMLHttpRequest'
                  }
              })
                  .then((response) => {
                      if (!response.ok) {
                          throw new Error(`Failed to load products: ${response.status}`);
                      }
                      return response.text();
                  })
                  .then((html) => {
                      productList.innerHTML = html;
                      setActive(activeElement);
                      updateCategoryDetails(activeElement);
                      attachAddToCartHandlers();
                  })
                  .catch((error) => {
                      console.error('Error loading products:', error);
                  });
          };

          categoryLinks.forEach((link) => {
              link.addEventListener('click', (event) => {
                  event.preventDefault();
                  const url = link.dataset.productsUrl || '';
                  loadProducts(url, link);
              });
          });

          if (allProductsLink) {
              allProductsLink.addEventListener('click', (event) => {
                  event.preventDefault();
                  const url = allProductsLink.dataset.productsUrl || '';
                  loadProducts(url, allProductsLink);
              });
          }
      });
      </script>
      {% endblock %}
  </body>
</html>
