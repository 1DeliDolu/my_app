<!DOCTYPE html>
<html>
  <head>
      <meta charset="UTF-8">
      <title>{% block title %}Shop{% endblock %}</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
      {{ importmap('app') }}
  </head>
  <body>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
          <div class="container px-4">
              <a class="navbar-brand fw-bold text-uppercase letter-spacing-1" href="{{ path('app_home') }}">
                  Pehli<span class="text-warning">ONE</span>
              </a>
              <button
                  class="navbar-toggler"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#mainNavbar"
                  aria-controls="mainNavbar"
                  aria-expanded="false"
                  aria-label="Toggle navigation"
              >
                  <span class="navbar-toggler-icon"></span>
              </button>

              <div class="collapse navbar-collapse" id="mainNavbar">
                  <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                      <li class="nav-item">
                          <a class="nav-link" href="{{ path('app_home') }}">Home</a>
                      </li>
                      <!-- admin ise kategoriler eklenecek -->
                       {% if is_granted('ROLE_ADMIN') %}
                      <li class="nav-item">
                          <a class="nav-link" href="{{ path('app_category_index') }}">Categories</a>
                      </li>
                      <!-- burada admin ise Ã¼rÃ¼n yÃ¶netimi linki eklenebilir -->
                       <li class="nav-item">
                          <a class="nav-link" href="{{ path('app_product_index') }}">Products</a>
                      </li>
                      {% endif %}
                  </ul>

                  <div class="d-flex align-items-center gap-3">
                      {% set cartCount = cartItemCount|default(0) %}
                      <a href="{{ path('app_cart_index') }}" class="btn btn-outline-light position-relative" aria-label="View cart">
                          <span class="fs-5" aria-hidden="true">ðŸ›’</span>
                          <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill {{ cartCount > 0 ? 'bg-warning text-dark' : 'bg-secondary' }}">
                              {{ cartCount }}
                              <span class="visually-hidden">items in cart</span>
                          </span>
                      </a>

                      {% if app.user %}
                          <div class="dropdown">
                              <button
                                  class="btn btn-link text-white text-decoration-none dropdown-toggle d-flex align-items-center p-0"
                                  type="button"
                                  id="userMenu"
                                  data-bs-toggle="dropdown"
                                  data-bs-display="static"
                                  aria-expanded="false"
                              >
                                  <span
                                      class="bg-white text-primary rounded-circle d-inline-flex justify-content-center align-items-center me-2 fw-semibold"
                                      style="width: 32px; height: 32px;"
                                  >
                                      {{ app.user.firstName|default(app.user.email)|first|upper }}
                                  </span>
                                  <strong>{{ app.user.firstName|default(app.user.email) }}</strong>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end shadow-sm mt-2" aria-labelledby="userMenu">
                                  <li>
                                      <span class="dropdown-item-text text-muted small">
                                          {{ app.user.email }}
                                      </span>
                                  </li>
                                  <li><hr class="dropdown-divider"></li>
                                  <li>
                                      <a class="dropdown-item" href="{{ path('app_order_index') }}">My Orders</a>
                                  </li>
                                  <li>
                                      <a class="dropdown-item" href="{{ path('app_address_index') }}">My Addresses</a>
                                  </li>
                                  {% if is_granted('ROLE_ADMIN') %}
                                      <li>
                                          <a class="dropdown-item" href="{{ path('app_admin_dashboard') }}">Admin Dashboard</a>
                                      </li>
                                      <li>
                                          <a class="dropdown-item" href="{{ path('app_admin_users') }}">Manage Users</a>
                                      </li>
                                  {% endif %}
                                  <li><hr class="dropdown-divider"></li>
                                  <li>
                                      <a class="dropdown-item text-danger" href="{{ path('app_logout') }}">Logout</a>
                                  </li>
                              </ul>
                          </div>
                      {% else %}
                          <div class="d-flex align-items-center gap-2">
                              <a href="{{ path('app_login') }}" class="btn btn-outline-light">Login</a>
                              <a href="{{ path('app_register') }}" class="btn btn-warning text-primary fw-semibold">Sign up</a>
                          </div>
                      {% endif %}
                  </div>
              </div>
          </div>
      </nav>

      <main class="py-4">
          {% block body %}{% endblock %}
      </main>

      <div class="modal fade" id="addToCartModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content shadow-lg border-0">
                  <div class="modal-header bg-success text-white">
                      <h5 class="modal-title">ÃœrÃ¼n sepete eklendi</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <p class="mb-1 text-muted">Sepete eklenen Ã¼rÃ¼n:</p>
                      <p class="h5 mb-3" id="modal-product-name">â€”</p>
                      <p class="text-muted mb-0">
                          AlÄ±ÅŸveriÅŸe devam etmek ister misiniz yoksa sepetinize gitmek mi istersiniz?
                      </p>
                  </div>
                  <div class="modal-footer bg-light border-0">
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">AlÄ±ÅŸveriÅŸe Devam Et</button>
                      <a href="{{ path('app_cart_index') }}" class="btn btn-success">Sepete Git</a>
                  </div>
              </div>
          </div>
      </div>

{% block javascripts %}
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script>
      const initUserDropdown = () => {
          if (typeof bootstrap === 'undefined') {
              return;
          }

          const toggle = document.getElementById('userMenu');
          if (!toggle) {
              return;
          }

          bootstrap.Dropdown.getOrCreateInstance(toggle, { autoClose: 'outside' });
      };

      const getAddToCartModal = () => {
          if (typeof bootstrap === 'undefined') {
              return null;
          }

          const modalElement = document.getElementById('addToCartModal');
          if (!modalElement) {
              return null;
          }

          return bootstrap.Modal.getOrCreateInstance(modalElement);
      };

      const updateCartCount = (value) => {
          const cartCountEl = document.getElementById('cart-count');
          if (!cartCountEl) {
              return;
          }

          const numericValue = Number.parseInt(value, 10);
          const safeValue = Number.isFinite(numericValue) && numericValue >= 0 ? numericValue : 0;
          cartCountEl.textContent = safeValue;

          cartCountEl.classList.remove('bg-warning', 'text-dark', 'bg-secondary');
          if (safeValue > 0) {
              cartCountEl.classList.add('bg-warning', 'text-dark');
          } else {
              cartCountEl.classList.add('bg-secondary');
          }
      };

      let addToCartHandlerBound = false;
      const attachAddToCartHandlers = () => {
          if (addToCartHandlerBound) {
              return;
          }
          addToCartHandlerBound = true;

          document.addEventListener('click', async (event) => {
              const button = event.target.closest('.add-to-cart');
              if (!button) {
                  return;
              }

              event.preventDefault();

              const cartUrl = button.dataset.cartUrl;
              if (!cartUrl) {
                  return;
              }

              let quantity = button.dataset.quantity || '1';
              const quantitySelector = button.dataset.quantityInput || button.dataset.quantitySelector;
              if (quantitySelector) {
                  const scope = button.closest('form') || button.closest('.card') || document;
                  let quantityInput = scope.querySelector(quantitySelector);

                  if (!quantityInput) {
                      quantityInput = document.querySelector(quantitySelector);
                  }
                  if (quantityInput && quantityInput.value) {
                      quantity = quantityInput.value;
                  }
              }

              const payload = new URLSearchParams();
              payload.set('quantity', quantity);

              button.disabled = true;
              button.classList.add('opacity-50');

              try {
                  const response = await fetch(cartUrl, {
                      method: 'POST',
                      headers: {
                          'X-Requested-With': 'XMLHttpRequest',
                          'Content-Type': 'application/x-www-form-urlencoded',
                      },
                      body: payload,
                  });

                  if (!response.ok) {
                      throw new Error(`Request failed with status ${response.status}`);
                  }

                  const data = await response.json();

                  if (data.success) {
                      if (data.cartCount !== undefined) {
                          updateCartCount(data.cartCount);
                      }

                      const modalProductName = document.getElementById('modal-product-name');
                      if (modalProductName) {
                          modalProductName.textContent = button.dataset.productName || 'ÃœrÃ¼n';
                      }

                      const addToCartModal = getAddToCartModal();
                      if (addToCartModal) {
                          addToCartModal.show();
                      } else {
                          const goToCart = window.confirm('ÃœrÃ¼n sepete eklendi. Sepete gitmek ister misiniz?');
                          if (goToCart) {
                              window.location.href = '{{ path('app_cart_index') }}';
                          }
                      }
                  } else if (button.dataset.fallbackForm) {
                      const fallbackForm = document.getElementById(button.dataset.fallbackForm);
                      if (fallbackForm) {
                          fallbackForm.submit();
                          return;
                      }
                  }
              } catch (error) {
                  console.error('Add to cart error:', error);
                  alert('ÃœrÃ¼n sepete eklenirken bir sorun oluÅŸtu. LÃ¼tfen tekrar deneyin.');
              } finally {
                  button.disabled = false;
                  button.classList.remove('opacity-50');
              }
          });
      };

      const initCategoryFilters = () => {
          const categoryList = document.getElementById('category-list');
          const productList = document.getElementById('product-list');

          if (!categoryList || !productList) {
              return;
          }

          if (categoryList.dataset.bound === 'true') {
              return;
          }
          categoryList.dataset.bound = 'true';

          const categoryTitle = document.getElementById('category-title');
          const categoryDescription = document.getElementById('category-description');

          const setActive = (activeElement) => {
              categoryList.querySelectorAll('.list-group-item').forEach((item) => {
                  item.classList.toggle('active', item === activeElement);
              });
          };

          const updateCategoryDetails = (sourceElement) => {
              if (!sourceElement) {
                  return;
              }

              if (categoryTitle) {
                  categoryTitle.textContent = sourceElement.dataset.categoryName || 'Products';
              }

              if (categoryDescription) {
                  const description = sourceElement.dataset.categoryDescription || '';
                  categoryDescription.textContent = description;
                  categoryDescription.classList.toggle('d-none', description.trim().length === 0);
              }
          };

          const loadProducts = async (url, activeElement) => {
              if (!url) {
                  return;
              }

              try {
                  const response = await fetch(url, {
                      headers: {
                          'X-Requested-With': 'XMLHttpRequest',
                      },
                  });

                  if (!response.ok) {
                      throw new Error(`Failed to load products: ${response.status}`);
                  }

                  const html = await response.text();
                  productList.innerHTML = html;
                  setActive(activeElement);
                  updateCategoryDetails(activeElement);
                  attachAddToCartHandlers();
              } catch (error) {
                  console.error('Error loading products:', error);
              }
          };

          categoryList.addEventListener('click', async (event) => {
              const link = event.target.closest('a.list-group-item');
              if (!link || !categoryList.contains(link)) {
                  return;
              }

              const url = link.dataset.productsUrl;
              if (!url) {
                  return;
              }

              event.preventDefault();
              await loadProducts(url, link);
          });
      };

      const refreshCartBadge = () => {
          const cartCountEl = document.getElementById('cart-count');
          if (!cartCountEl) {
              return;
          }
          updateCartCount(cartCountEl.textContent);
      };

      document.addEventListener('DOMContentLoaded', () => {
          initUserDropdown();
          attachAddToCartHandlers();
          initCategoryFilters();
          refreshCartBadge();
      });

      document.addEventListener('turbo:load', () => {
          initUserDropdown();
          initCategoryFilters();
          refreshCartBadge();
      });
      </script>
{% endblock %}
  </body>
</html>
